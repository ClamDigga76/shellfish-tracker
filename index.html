<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Shellfish Tracker</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2f6df6">
<link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32.png">
<link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Shellfish Tracker">

<style>
:root{
  --bg0:#060a12;
  --bg1:#0a1224;
  --panel:rgba(255,255,255,.06);
  --panel2:rgba(255,255,255,.085);
  --stroke:rgba(255,255,255,.10);
  --stroke2:rgba(255,255,255,.14);
  --text:#eaf0ff;
  --muted:rgba(234,240,255,.72);
  --muted2:rgba(234,240,255,.55);
  --blue:#3b82f6;
  --blue2:#60a5fa;
  --teal:#22c55e;
  --danger:#ff4d4f;
  --r:22px;
  --r2:28px;
  --shadow:0 18px 60px rgba(0,0,0,.55);
  --glow:0 0 0 1px rgba(255,255,255,.07), 0 18px 50px rgba(0,0,0,.55);
  --glass: blur(14px) saturate(1.25);
  --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:var(--font);
  color:var(--text);
  background:
    radial-gradient(1100px 700px at 75% -10%, rgba(96,165,250,.45) 0%, rgba(96,165,250,0) 55%),
    radial-gradient(900px 600px at 10% 10%, rgba(59,130,246,.25) 0%, rgba(59,130,246,0) 60%),
    radial-gradient(1200px 800px at 50% 120%, rgba(59,130,246,.16) 0%, rgba(59,130,246,0) 65%),
    linear-gradient(180deg, var(--bg1), var(--bg0));
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding:calc(14px + env(safe-area-inset-top)) 10px calc(16px + env(safe-area-inset-bottom));
}

.phone{
  width:430px;
  max-width:100vw;
  border-radius:34px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(10,18,36,.60);
  -webkit-backdrop-filter:var(--glass);
  backdrop-filter:var(--glass);
  box-shadow:var(--shadow);
  overflow:hidden;
}

header{
  position:relative;
  padding:20px 18px 14px;
  border-bottom:1px solid var(--stroke);
  overflow:hidden;
}
header::before{
  content:"";
  position:absolute;
  inset:-40px -60px -60px -60px;
  background:
    radial-gradient(1000px 380px at 70% 10%, rgba(96,165,250,.40) 0%, rgba(96,165,250,0) 60%),
    radial-gradient(780px 320px at 0% 30%, rgba(59,130,246,.22) 0%, rgba(59,130,246,0) 65%),
    linear-gradient(180deg, rgba(255,255,255,.08) 0%, rgba(255,255,255,0) 55%);
  filter:saturate(1.2);
  opacity:.95;
}
header::after{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.15) 55%, rgba(0,0,0,.25) 100%);
  pointer-events:none;
}
header h1, header p{position:relative; z-index:1}
header h1{
  margin:0;
  font-size:22px;
  letter-spacing:.2px;
  display:flex;
  align-items:center;
  gap:10px;
}
header p{
  margin:10px 0 0;
  color:var(--muted);
  font-size:13px;
  line-height:1.35;
}

.boot{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid rgba(34,197,94,.35);
  background:rgba(34,197,94,.12);
  color:#b9ffcf;
  font-size:12px;
  letter-spacing:.2px;
}
.boot.err{
  border-color:rgba(255,77,79,.55);
  background:rgba(255,77,79,.14);
  color:#ffd1da;
}

main{padding:14px 14px 18px}
main#app{min-height:55vh}

.card{
  background:linear-gradient(180deg, var(--panel2), var(--panel));
  border:1px solid var(--stroke);
  border-radius:var(--r2);
  padding:14px;
  margin-bottom:12px;
  box-shadow:var(--glow);
  -webkit-backdrop-filter:var(--glass);
  backdrop-filter:var(--glass);
}
.card.soft{
  background:rgba(255,255,255,.05);
  box-shadow:0 0 0 1px rgba(255,255,255,.06), 0 16px 45px rgba(0,0,0,.50);
}

.row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.actions{display:flex; gap:10px; flex-wrap:wrap}

.btn{
  appearance:none;
  border:1px solid var(--stroke);
  border-radius:999px;
  background:rgba(15,23,42,.35);
  color:var(--text);
  padding:12px 16px;
  font-weight:800;
  font-size:15px;
  letter-spacing:.1px;
  box-shadow:0 0 0 1px rgba(255,255,255,.06), 0 10px 30px rgba(0,0,0,.45);
  -webkit-backdrop-filter:var(--glass);
  backdrop-filter:var(--glass);
  cursor:pointer;
  -webkit-tap-highlight-color:transparent;
  touch-action:manipulation;
}
.btn:active{transform:translateY(1px); filter:brightness(1.05)}
.btn.primary{
  background:linear-gradient(180deg, rgba(96,165,250,.95) 0%, rgba(59,130,246,.92) 55%, rgba(37,99,235,.90) 100%);
  border-color:rgba(96,165,250,.40);
  box-shadow:0 0 0 1px rgba(255,255,255,.08), 0 18px 50px rgba(59,130,246,.22), 0 18px 55px rgba(0,0,0,.55);
}
.btn.danger{
  border-color:rgba(255,77,79,.45);
  background:rgba(255,77,79,.14);
  color:#ffe7ec;
}
.btn.small{padding:8px 12px; font-size:13px; font-weight:800}

.hint{margin-top:10px; color:var(--muted2); font-size:12.5px; line-height:1.35}
.muted{color:var(--muted)}
.small{font-size:12px}

.pill{
  display:inline-flex;
  gap:6px;
  align-items:baseline;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--stroke);
  background:rgba(255,255,255,.05);
  color:var(--muted);
  font-size:12px;
  -webkit-backdrop-filter:var(--glass);
  backdrop-filter:var(--glass);
}
.pill b{color:#dbe6ff}

.chip{
  appearance:none;
  border:1px solid var(--stroke);
  background:rgba(255,255,255,.04);
  color:var(--muted);
  padding:9px 12px;
  border-radius:999px;
  font-weight:900;
  font-size:13px;
}
.chip.on{
  background:linear-gradient(180deg, rgba(96,165,250,.35) 0%, rgba(59,130,246,.22) 100%);
  border-color:rgba(96,165,250,.40);
  color:#eaf0ff;
  box-shadow:0 0 0 1px rgba(255,255,255,.06), 0 12px 35px rgba(59,130,246,.18);
}

.input,.select,.textarea{
  width:100%;
  padding:12px 12px;
  border-radius:16px;
  border:1px solid var(--stroke);
  background:rgba(2,6,23,.45);
  color:var(--text);
  font-size:15px;
  outline:none;
  -webkit-backdrop-filter:var(--glass);
  backdrop-filter:var(--glass);
}
.textarea{min-height:120px; resize:vertical}

.triplist{display:flex; flex-direction:column; gap:10px}
.trip{
  border:1px solid var(--stroke);
  border-radius:var(--r2);
  padding:12px;
  background:rgba(255,255,255,.04);
  -webkit-backdrop-filter:var(--glass);
  backdrop-filter:var(--glass);
}
.trip-top{display:flex; justify-content:space-between; gap:10px}
.trip-date{font-weight:900}
.trip-dealer{font-weight:900}
.trip-meta{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}

.areachips{display:flex; gap:8px; flex-wrap:wrap}
.areachip{
  appearance:none;
  border:1px solid var(--stroke);
  background:rgba(255,255,255,.04);
  color:var(--muted);
  padding:8px 10px;
  border-radius:999px;
  font-weight:900;
  font-size:13px;
}
.areachip:active{transform:translateY(1px)}

#toast{
  position:fixed;
  left:50%;
  bottom:calc(18px + env(safe-area-inset-bottom));
  transform:translateX(-50%);
  max-width:92vw;
  padding:10px 14px;
  border-radius:999px;
  border:1px solid var(--stroke2);
  background:rgba(0,0,0,.55);
  color:var(--text);
  opacity:0;
  pointer-events:none;
  transition:opacity .18s ease;
  -webkit-backdrop-filter:var(--glass);
  backdrop-filter:var(--glass);
}
#toast.show{opacity:1}

#credits,#credit{color:var(--muted2); font-size:11px; text-align:center}
#credits a,#credit a{color:rgba(219,230,255,.85); text-decoration:none}
#credits a:active,#credit a:active{opacity:.85}

/* layout helpers used by the app */
.grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
@media (max-width:420px){ .grid2{grid-template-columns:1fr} }

.form{display:flex;flex-direction:column;gap:10px}
.field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
.label{font-size:12px;font-weight:900;color:var(--muted2);letter-spacing:.15px}
.sep{height:1px;background:rgba(255,255,255,.10);margin:12px 0;border:0}
.filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pillbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.good{color:#b9ffcf}
.btn.ghost{background:rgba(255,255,255,.03);border-color:rgba(255,255,255,.10);color:var(--text);box-shadow:none}
.smallbtn{appearance:none;border:1px solid var(--stroke);background:rgba(255,255,255,.04);color:var(--text);padding:8px 10px;border-radius:14px;font-weight:900;font-size:13px}
.chart{width:100%;border:1px solid var(--stroke);border-radius:var(--r2);background:rgba(255,255,255,.03);padding:10px;overflow:hidden}

</style>
</head>
<body>
  <div class="phone">
    <header>
      <h1>Shellfish Tracker <span id="bootPill" class="boot">Field Test</span></h1>
      <p>Copy receipt text with Live Text, then tap Paste → Review. Review → Confirm saves.</p>
    </header>
    <main id="app"></main>
  </div>

  <script type="module">
  const pill = document.getElementById("bootPill");
  const app = document.getElementById("app");

  // Make error handler available to non-module scripts if needed
  window.__showModuleError = function(err){
    try{
      if(pill){
        pill.textContent = "ERROR";
        pill.classList.add("err");
        pill.title = "Module error";
      }
      const msg =
        (err && (err.stack || err.message)) ? String(err.stack || err.message)
        : String(err || "Module import failed");
      try{ localStorage.setItem("shellfish-last-error", msg); }catch{}
      try{ localStorage.setItem("shellfish-last-error-at", new Date().toISOString()); }catch{}

      const esc = msg.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
      try{
        localStorage.setItem("shellfish-last-error", msg);
        localStorage.setItem("shellfish-last-error-at", new Date().toISOString());
      }catch(e){}

      app.innerHTML = `
        <div class="card">
          <b>Module failed to load.</b>
          <div class="sep"></div>
          <div class="muted small" style="white-space:pre-wrap">${esc}</div>
          <div class="row" style="margin-top:12px;gap:10px;flex-wrap:wrap">
            <button class="btn" id="copyErr">Copy</button>
            <button class="btn" id="reload">Reload</button>
            <button class="btn" id="resetCache">Reset Cache</button>
          </div>
        </div>
      `;

      const copyBtn = document.getElementById("copyErr");
      if(copyBtn){
        copyBtn.onclick = async ()=>{
          try{
            await navigator.clipboard.writeText(msg);
            copyBtn.textContent = "Copied";
            setTimeout(()=> copyBtn.textContent="Copy", 900);
          }catch(e){
            // fallback: select text
            const pre = document.createElement("textarea");
            pre.value = msg;
            pre.style.position="fixed";
            pre.style.left="-9999px";
            document.body.appendChild(pre);
            pre.select();
            document.execCommand("copy");
            document.body.removeChild(pre);
            copyBtn.textContent = "Copied";
            setTimeout(()=> copyBtn.textContent="Copy", 900);
          }
        };
      }

      const r = document.getElementById("reload");
      if(r) r.onclick = ()=> location.reload();

      const z = document.getElementById("resetCache");
      if(z) z.onclick = async ()=>{
        try{
          if("serviceWorker" in navigator){
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map(r=>r.unregister()));
          }
          if("caches" in window){
            const keys = await caches.keys();
            await Promise.all(keys.map(k=>caches.delete(k)));
          }
        }catch(e){}
        location.reload();
      };
    }catch(e){
      console.error("Error rendering module error UI", e);
    }
    console.error(err);
  };

    // Boot watchdog: if the module never starts (common with stale SW caches), show recovery UI.
  window.__BOOT_WATCHDOG__ = setTimeout(()=>{
    try{
      if(!window.__SHELLFISH_APP_STARTED){
        const errMsg = (function(){
          try{ return localStorage.getItem("shellfish-last-error") || localStorage.getItem("SHELLFISH_LAST_ERROR") || "App did not start (possible cached/stale JS)."; }catch(_){ return "App did not start (possible cached/stale JS)."; }
        })();
        window.__showModuleError({message: errMsg});
      }
    }catch(e){}
  }, 4000);

// Load the app module (direct src, avoids dynamic import syntax issues on some Safari builds).
</script>

  <script type="module" src="./js/app_0083.js" onerror="window.__showModuleError && window.__showModuleError(event)"></script>


  <script>
    // Watchdog: if the module doesn't start, show a helpful error card.
    window.__SHELLFISH_STARTED = false;
    window.__SHELLFISH_BOOT_AT = Date.now();
    setTimeout(function(){
      if(window.__SHELLFISH_STARTED) return;
      try{
        const msg = "App did not start. This usually means the JS module failed to load (cached old files or a network error). Tap Reset Cache then Reload.

If it still fails: open Safari Settings → Advanced → Website Data → delete this site, then reload.";
        if(window.__showModuleError) window.__showModuleError(new Error(msg));
        else console.error(msg);
      }catch(e){}
    }, 1800);
  </script>

<script>
  // PWA offline support + deterministic update UX (RC)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try {
        const reg = await navigator.serviceWorker.register("./sw.js");

        const banner = document.getElementById("swUpdateBanner");
        const btnApply = document.getElementById("swUpdateApply");
        const btnDismiss = document.getElementById("swUpdateDismiss");

        const showBanner = () => { if (banner) banner.style.display = "block"; };
        const hideBanner = () => { if (banner) banner.style.display = "none"; };

        if (btnDismiss) btnDismiss.onclick = hideBanner;

        if (btnApply) {
          btnApply.onclick = async () => {
            try {
              const waiting = reg.waiting;
              if (waiting) waiting.postMessage({ type: "SKIP_WAITING" });
            } catch (_) {}
          };
        }

        // If there's already a waiting worker, prompt immediately.
        if (reg.waiting) showBanner();

        // When a new SW is found, prompt once it's installed (and we already have a controller).
        reg.addEventListener("updatefound", () => {
          const nw = reg.installing;
          if (!nw) return;
          nw.addEventListener("statechange", () => {
            if (nw.state === "installed" && navigator.serviceWorker.controller) showBanner();
          });
        });

        // Once the new SW takes control, reload to get fresh assets.
        navigator.serviceWorker.addEventListener("controllerchange", () => {
          window.location.reload();
        });
      } catch (_) {}
    });
  }
</script>

<div id="swUpdateBanner" class="card" style="position:fixed;left:12px;right:12px;bottom:78px;z-index:9999;display:none">
    <b>Update available</b>
    <div class="muted small" style="margin-top:6px;line-height:1.35">
      A new version is ready. Reload to apply it.
    </div>
    <div class="row" style="margin-top:10px;gap:10px">
      <button class="btn good" id="swUpdateApply">Reload now</button>
      <button class="btn" id="swUpdateDismiss">Later</button>
    </div>
  </div>

<footer id="credit">Created by Jeremy Wood — <a href="mailto:jeremywwood76@gmail.com">jeremywwood76@gmail.com</a></footer>
  <div id="toast"></div>
</body>
</html>
